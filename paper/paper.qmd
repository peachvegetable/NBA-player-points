---
title: "My title"
subtitle: "My subtitle if needed"
author: 
  - Yihang  Cai
thanks: "Code and data are available at: https://github.com/peachvegetable/NBA-player-points"
date: today
date-format: long
abstract: "First sentence. Second sentence. Third sentence. Fourth sentence."
format: pdf
number-sections: true
bibliography: references.bib
---

```{r}
#| include: false
#| warning: false
#| message: false

### work space setup ###
library(tidyverse)
library(arrow)
library(tidymodels)
library(modelsummary)
library(ggplot2)
library(knitr)
library(janitor)
```


# Introduction

You can and should cross-reference sections and sub-sections. We use @citeR and @rohan.

The remainder of this paper is structured as follows. @sec-data....



# Data {#sec-data}

The dataset is obtained from Basketball Reference @citeDataset, which contains NBA players' statistics in the 2023 to 2024 season. The dataset is directly downloaded from Basketball Reference using the given instruction. The dataset contains different statistics of NBA players, for instance, players' position, age, assists, steals, etc. There are in total of 718 observations before any data cleanings. 

```{r}
#| echo: false
#| warning: false
#| message: false
#| label: tbl-top5players
#| tbl-cap: Top 5 NBA Players Based on Select Predictors Highly Correlated with Points Scored, Season 2023-2024

raw_data <- read_csv("../data/raw_data/raw_data.csv")

raw_data |> 
  drop_na() |>
  clean_names() |>
  head(5) |> 
  select(player, x3p, x2p, ft, pts) |>
  rename(
    Player = player,
    "3-point goals" = x3p,
    "2-point goals" = x2p,
    "free throws" = ft,
    "points" = pts
  ) |>
  kable()
```


This dataset contains player statistics including 3-point goals, 2-point goals, field goals, and free throws, points can be calculated using these variables. My goal is to predict the number of points a NBA player scores based on his performance, which means that these features are too closely related to the target variable (i.e. points). @tbl-top5players shows the table with closely related variables, we can calculate the points a player scored directly using these variables. For instance, player Bam Adebayo had 10 3-points goals, 470 2-point goals and 276 free throws during the 2023-2024 season, so his total points gained is $10 \cdot 3 + 470 \cdot 2 + 1 \cdot 276 = 1246$, which is exactly the points he scored. Thus, those variables are removed from the dataset using 'tidyverse' package in R @citeTidyverse. Moreover, there are 12 different positions in the dataset, I categorized them into a broader classification which has only three categories - Guards (G): SG, PG, SG-PG, PG-SG, Forwards (F): SF, PF, PF-SF, SF-PF, SF-SG, and Centers (C): C, PF-C, C-PF. This is done so that I don't need to create overwhelming dummy variables when generating the model and this process of binning could simplify the model and potentially strengthen the signal by reducing noise and multicollinearity. Additionally, redundant variables are also removed like 

```{r}
#| echo: false
#| warning: false
#| message: false
#| label: tbl-top10players
#| tbl-cap: Top 10 NBA Players with selectely statistics, Season 2023-2024

analysis_data <- read_parquet("../data/analysis_data/analysis_data.parquet")

analysis_data |>
  head(10) |>
  kable()
```


After removing the closely related features, the dataset contains the following variables as @tbl-top10players shows:
1. player: the player name, which includes the players that played in the 2023-2024 season.
2. age: the age of each player.
3. g: games, how many games a player played in this season.
4. gs: game started, how many games a player has been in the starting lineup for their team at the beginning of the game.
5. mp: minutes played, the total time of a player played in this season.
6. fg_percent: field goal percentage, this statistic represents the percentage of field goals (both 2-pointers and 3-pointers) made by a player out of the total number of field goal attempts.
7. x3p_percent: 3-point goal percentage, this statistic represents the percentage of 3-point field goals made by a player out of the total number of 3-point field goal attempts.
8. x2p_percent: 2-point goal percentage, this statistic represents the percentage of 2-point field goals made by a player out of the total number of 2-point field goal attempts.
9. e_fg_percent: effective field goal percentage, this statistic adjusts for the fact that a 3-point field goal is worth more than a 2-point field goal.
10. ft_percent: free throw percentage, this statistic represents the percentage of free throws made by a player out of the total number of free throw attempts.
11. orb: offensive rebounds, this statistic represents the number of rebounds grabbed by a player on the offensive end of the court.
12. drb: defensive rebounds, this statistic represents the number of rebounds grabbed by a player on the defensive end of the court.
13. trb: total rebounds, this statistic represents the total number of rebounds grabbed by a player (both offensive and defensive rebounds).


# Model

Lasso regression is a variation of linear regressions that can actually perform feature selection by setting the coefficients of less important features to zero. It has an additional parameter $\lambda$, which is the regularization parameter that controls the strength of the penalty. The penalty term shrinks some of the coefficients (i.e. the less important variables) toward zero. As $\lambda$ increases, more coefficients are set to zero, leading to a simpler model. The value of $\lambda$ is determined through cross-validation. 

## Model set-up

\begin{align} 
y_i = \beta_0 + \beta_i \cdot X_i
\end{align}

In this equation, $y_i$ is the number of points a player scores, which is the dependent variable I am trying to predict. $\beta_0$ is the interception, and $\beta_i$ is a matrix that contains the coefficients $\beta_1, \beta_2, ..., \beta_{18}$ for each predictor that the lasso regression will estimate. $X_i$ is also a matrix contains the predictors: players position, age, games, game starts, minutes played, field goal percentage, 3-point field goal percentage, 2-point field goal percentage, effective field goal percentage, free throw percentage, offensive rebounds, defensive rebounds, total rebounds, assists, steals, blocks, turnovers, and personal fouls. 

We run the model in R [@citeR] using the `tidymodels` package of @citeTidymodels.

## Model justification

We expect a positive relationship between the size of the wings and time spent aloft. In particular...

We can use maths by including latex between dollar signs, for instance $\theta$.

```{r}
# #| include: false
# #| warning: false
# #| message: false
# 
# first_lasso_model <- readRDS("../models/first_lasso_model.rds")
# second_lasso_model <- readRDS("../models/second_lasso_model.rds")
# predictions <- predict(second_lasso_model, test_data)
# results <- bind_cols(test_data, predictions)
# # Calculate RMSE
# rmse_results_2 <- rmse(results, truth = pts, estimate = .pred)
# rsq_results_2 <- rsq(results, truth = pts, estimate = .pred)
```


# Results

Our results are summarized in @tbl-modelresults.







# Discussion

## First discussion point {#sec-first-point}

If my paper were 10 pages, then should be be at least 2.5 pages. The discussion is a chance to show off what you know and what you learnt from all this. 

## Second discussion point

## Third discussion point

## Weaknesses and next steps

Weaknesses and next steps should also be included.

\newpage

\appendix

# Appendix {-}

```{r}
#| include: false
#| warning: false
#| message: false


analysis_data <- read_parquet("../data/analysis_data/analysis_data.parquet")

predictors <- c("g", "gs", "mp", "fg_percent", "x3p_percent", 
                "x2p_percent", "e_fg_percent", "ft_percent", 
                "orb", "drb", "trb", "ast", "stl", "blk", "tov", "pf")

for (predictor in predictors) {
  p <- ggplot(analysis_data, aes_string(x = predictor, y = "pts")) + 
    geom_point(alpha = 0.5) + 
    geom_smooth(method = "lm", se = FALSE, color = "blue") + 
    ggtitle(paste("Points vs", predictor)) +
    theme_minimal()
  
  print(p)
}
```



# Additional data details

# Model details {#sec-model-details}

## Posterior predictive check

In @fig-ppcheckandposteriorvsprior-1 we implement a posterior predictive check. This shows...

In @fig-ppcheckandposteriorvsprior-2 we compare the posterior with the prior. This shows... 


## Diagnostics

@fig-stanareyouokay-1 is a trace plot. It shows... This suggests...

@fig-stanareyouokay-2 is a Rhat plot. It shows... This suggests...





\newpage


# References


